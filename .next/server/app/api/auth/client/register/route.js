(()=>{var e={};e.id=642,e.ids=[642],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},23952:(e,t,r)=>{"use strict";r.d(t,{z:()=>i});var n=r(96330);let i=global.prisma||new n.PrismaClient({log:["error"]})},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},39676:(e,t,r)=>{"use strict";r.d(t,{i:()=>a});let n=process.env.POSTER_TOKEN||process.env.POSTER_ACCESS_TOKEN,i=process.env.POSTER_BASE_URL;function s(e,t){if(!t)throw Error(`Missing env ${e}`);return t}async function a(e,t={},r={}){let l=s("POSTER_TOKEN",n),o=s("POSTER_BASE_URL",i).replace(/\/$/,""),u=r.httpMethod??"GET",c=new URL(`${o}/${e}`);c.searchParams.set("token",l),c.searchParams.set("format","json");let p={cache:"no-store",method:u};if("GET"===u)for(let[e,r]of Object.entries(t))void 0!==r&&c.searchParams.set(e,String(r));else{let e=new URLSearchParams;for(let[r,n]of Object.entries(t))void 0!==n&&e.set(r,String(n));p.headers={"content-type":"application/x-www-form-urlencoded;charset=UTF-8"},p.body=e.toString()}let f=await fetch(c.toString(),p),d=await f.text().catch(()=>"");if(!f.ok)throw Error(`Poster error ${f.status}: ${d||f.statusText}`);let m=d?JSON.parse(d):{};if(m?.error){let e="object"==typeof m.error?JSON.stringify(m.error):String(m.error),t=m?.message?` ${m.message}`:"";throw Error(`Poster API error: ${e}${t}`)}return m}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},63464:(e,t,r)=>{"use strict";r.d(t,{P:()=>i});let n=new Map;async function i(e,t,r){let i=Date.now(),s=n.get(e);if(s&&s.expiresAt>i)return s.value;let a=await r();return n.set(e,{value:a,expiresAt:i+t}),a}},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79654:(e,t,r)=>{"use strict";r.d(t,{H0:()=>p,JE:()=>f,bu:()=>d,cz:()=>s,sc:()=>u});var n=r(39676),i=r(63464);function s(e){return e.replace(/\D/g,"")}function a(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;if("string"==typeof e){let t=Number(e.replace(/\s+/g,"").replace(",",".").replace(/[^0-9.-]/g,""));return Number.isFinite(t)?t:null}if("object"==typeof e)for(let t of Object.values(e)){let e=a(t);if(null!==e)return e}return null}function l(e){if(!e)return[];if(Array.isArray(e))return e;let t=e.response??e.clients??e.data??e.result??e;return Array.isArray(t)?t:Array.isArray(t?.data)?t.data:Array.isArray(t?.clients)?t.clients:Array.isArray(t?.items)?t.items:t&&"object"==typeof t&&(t.client_id||t.id)?[t]:[]}function o(e){return String(e.phone??e.phone_number??e.tel??"").trim()||""}function u(e){let t=function(e){let t=e.client_id??e.id??e.clientId??e.client_id_poster??e.customer_id??e.customerId;return(null!=t?String(t).trim():"")||null}(e);return t?{id:t,name:function(e){let t=String(e.client_name??e.name??e.full_name??e.fullname??"").trim();if(t)return t;let r=String(e.firstname??e.first_name??e.firstName??"").trim();return[r,String(e.lastname??e.last_name??e.lastName??"").trim(),String(e.patronymic??e.middle_name??e.middleName??"").trim()].filter(Boolean).join(" ")}(e),phone:function(e){let t=String(e||"").trim();if(!t)return"";if(t.startsWith("+"))return t;let r=s(t);return r?r.startsWith("998")?`+${r}`:9===r.length?`+998${r}`:10===r.length&&r.startsWith("0")?`+998${r.slice(1)}`:t:t}(o(e)),bonus:function(e){let t=a(e.bonus)??a(e.bonus_points)??a(e.bonus_sum)??a(e.bonus_total)??a(e.bonus_amount)??a(e.balance);return null!=t?t/100:0}(e)}:null}async function c(){let e=process.env.POSTER_CLIENT_GROUP_ID;if(e&&e.trim())return e.trim();try{let e=await (0,i.P)("poster:client_groups",3e5,()=>(0,n.i)("clients.getGroups")),t=Array.isArray(e?.response)?e.response:[];if(!t.length)return null;let r=t.find(e=>"1"!==String(e?.delete??"0"))??t[0],s=r?.client_groups_id;if(null==s)return null;return String(s).trim()||null}catch{return null}}async function p(e){let t=String(e||"").trim();if(!t)return null;let r=s(t),i=r?`+${r}`:"",a=async e=>l(await (0,n.i)("clients.getClients",{phone:e}));try{let e=[t,r,i].filter(Boolean),n=new Set,l=[];for(let t of e)if(!n.has(t)&&(n.add(t),(l=await a(t)).length))break;if(!l.length)return null;let u=r||s(t);return l.find(e=>{let t=s(o(e));return!!t&&!!u&&t===u})??l[0]??null}catch{return null}}async function f(e){let t=String(e||"").trim();if(!t)return null;try{let e=await (0,n.i)("clients.getClient",{client_id:t});return l(e)[0]??null}catch{try{let e=await (0,n.i)("clients.getClients",{client_id:t});return l(e)[0]??null}catch{return null}}}async function d({name:e,phone:t,email:r,birthday:i}){let a=String(e||"").trim(),o=String(t||"").trim();if(!a||!o)return null;let u=s(o),p=u?`+${u}`:"",f=function(e){if(!e)return;let t=e.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(t)return`${t[3]}.${t[2]}.${t[1]}`}(i),d=function(e){if(!e)return;let t=e.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(t)return`${t[3]}-${t[2]}-${t[1]}`}(i),m=a.split(/\s+/).filter(Boolean),h=m[0]||"",_=m.slice(1).join(" ")||"",g=await c()||void 0,E=r||void 0,y=async(e,t)=>{let r=await (0,n.i)(e,t,{httpMethod:"POST"}),i=l(r);if(i.length)return i[0];let s=r?.response??r;return s&&"object"==typeof s?s:null},w=[o,u,p].filter(Boolean),b=[i,f,d].filter(Boolean),S=[];for(let e of w){for(let t of(S.push({client_name:a,phone:e,client_phone:e,phone_number:e,client_groups_id_client:g,email:E}),b))S.push({client_name:a,phone:e,client_phone:e,phone_number:e,client_groups_id_client:g,email:E,birthday:t,birthdate:t,birth_date:t});S.push({name:a,phone:e,client_phone:e,phone_number:e,client_groups_id_client:g,email:E}),h&&S.push({first_name:h,last_name:_||void 0,client_name:a,phone:e,client_phone:e,phone_number:e,client_groups_id_client:g,email:E})}let N=null;for(let e of["clients.createClient","clients.create","clients.addClient","clients.createOrUpdate"])for(let t of S)try{let r=await y(e,t);if(r)return r}catch(r){let e=r instanceof Error?r.message:String(r),t=/Unknown API method|Unknown method/i.test(e);(!N||!t||/Unknown API method|Unknown method/i.test(N))&&(N=e)}if(N)throw Error(N);return null}},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{},96925:(e,t,r)=>{"use strict";r.d(t,{S_:()=>c,a6:()=>p,rm:()=>f});var n=r(43008),i=r.n(n),s=r(44512);let a=process.env.CLIENT_COOKIE_NAME||"wasabi_client_session";function l(){let e=process.env.CLIENT_JWT_SECRET||process.env.ADMIN_JWT_SECRET;if(!e)throw Error("Missing CLIENT_JWT_SECRET");return e}async function o(e){(await (0,s.UL)()).set(a,e,{httpOnly:!0,sameSite:"lax",secure:!0,path:"/"})}async function u(){(await (0,s.UL)()).set(a,"",{httpOnly:!0,sameSite:"lax",secure:!0,path:"/",maxAge:0})}async function c(e){let t=function(e){let t=l();return i().sign(e,t,{expiresIn:"30d"})}({sub:e.clientId,phone:e.phone,name:e.name});await o(t)}async function p(){let e=await (0,s.UL)(),t=e.get(a)?.value;if(!t)return null;let r=function(e){try{let t=l();return i().verify(e,t)}catch{return null}}(t);return r?{clientId:r.sub,phone:r.phone,name:r.name}:null}async function f(){await u()}},97482:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>w,routeModule:()=>_,serverHooks:()=>y,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>E});var n={};r.r(n),r.d(n,{POST:()=>h});var i=r(42706),s=r(28203),a=r(45994),l=r(39187),o=r(65658),u=r(79654),c=r(96925),p=r(23952),f=r(99001);let d=o.Ik({name:o.Yj().min(2),phone:o.Yj().min(6),birthday:o.Yj().optional().or(o.eu("")),password:o.Yj().min(1)});function m(e){if(!e)return null;let t=String(e).trim();if(!t)return null;let r=t.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T].*)?$/),n=t.match(/^(\d{2})\.(\d{2})\.(\d{4})(?:\s.*)?$/),i=t.match(/^(\d{2})-(\d{2})-(\d{4})(?:\s.*)?$/),s=t.match(/^(\d{4})\/(\d{2})\/(\d{2})(?:\s.*)?$/),a=null,l=null,o=null;if(r)a=Number(r[1]),l=Number(r[2]),o=Number(r[3]);else if(n)a=Number(n[3]),l=Number(n[2]),o=Number(n[1]);else if(i)a=Number(i[3]),l=Number(i[2]),o=Number(i[1]);else{if(!s)return null;a=Number(s[1]),l=Number(s[2]),o=Number(s[3])}if(!a||!l||!o||a<1900||l<1||l>12||o<1||o>31)return null;let u=new Date(Date.UTC(a,l-1,o));if(u.getUTCFullYear()!==a||u.getUTCMonth()+1!==l||u.getUTCDate()!==o)return null;let c=e=>String(e).padStart(2,"0");return`${a}-${c(l)}-${c(o)}`}async function h(e){let t=await e.json().catch(()=>null),r=d.safeParse(t);if(!r.success)return l.NextResponse.json({error:"INVALID_BODY"},{status:400});let n=r.data,i=n.birthday?.trim()||void 0,s=m(n.birthday),a=n.phone.trim(),o=(0,u.cz)(a);if(!o||o.length<6)return l.NextResponse.json({error:"INVALID_PHONE"},{status:400});let h=n.password.trim();if(h.length<8)return l.NextResponse.json({error:"PASSWORD_TOO_SHORT"},{status:400});if(await p.z.clientUser.findUnique({where:{phoneNormalized:o}}))return l.NextResponse.json({error:"CLIENT_ALREADY_REGISTERED"},{status:409});let _=await (0,u.H0)(a),g=!!_,E=!1,y=null;if(!_)try{E=!!(_=await (0,u.bu)({name:n.name,phone:a,birthday:i})),g=!1}catch(e){y=e instanceof Error?e.message:String(e)}if(!_&&o&&o!==a&&(_=await (0,u.H0)(o),E=!1,g=!!_),!_)return l.NextResponse.json({error:"CLIENT_CREATE_FAILED",detail:y||"Poster create failed"},{status:502});if(g){var w;let e=m((w=_,w?.birthday??w?.birthdate??w?.birth_date??null));if(e){if(!s)return l.NextResponse.json({error:"BIRTHDAY_REQUIRED"},{status:400});if(s!==e)return l.NextResponse.json({error:"BIRTHDAY_MISMATCH"},{status:403})}}let b=(0,u.sc)(_);if(!b)return l.NextResponse.json({error:"CLIENT_CREATE_FAILED"},{status:500});let S=await (0,u.JE)(b.id),N=(S?(0,u.sc)(S):null)||b;if(await p.z.clientUser.findUnique({where:{posterClientId:N.id}}))return l.NextResponse.json({error:"CLIENT_ALREADY_REGISTERED"},{status:409});try{let e=await (0,f.E)(h);await p.z.clientUser.create({data:{posterClientId:N.id,phone:N.phone||a,phoneNormalized:o,passwordHash:e}})}catch(e){if("P2002"===(e&&"object"==typeof e&&"code"in e?e.code:""))return l.NextResponse.json({error:"CLIENT_ALREADY_REGISTERED"},{status:409});return l.NextResponse.json({error:"CLIENT_SAVE_FAILED"},{status:500})}return await (0,c.S_)({clientId:N.id,phone:N.phone||a,name:N.name||n.name}),l.NextResponse.json({client:N,created:E})}let _=new i.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/auth/client/register/route",pathname:"/api/auth/client/register",filename:"route",bundlePath:"app/api/auth/client/register/route"},resolvedPagePath:"/Users/mycomp/Documents/IT/Projects/wasabi/wasabi-sayt-2/app/api/auth/client/register/route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:g,workUnitAsyncStorage:E,serverHooks:y}=_;function w(){return(0,a.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:E})}},99001:(e,t,r)=>{"use strict";r.d(t,{B:()=>a,E:()=>s});var n=r(58964),i=r.n(n);async function s(e){let t=await i().genSalt(10);return i().hash(e,t)}async function a(e,t){return i().compare(e,t)}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[638,5452,4512,3008,5658,8964],()=>r(97482));module.exports=n})();