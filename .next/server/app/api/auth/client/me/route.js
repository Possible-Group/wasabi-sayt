(()=>{var e={};e.id=8335,e.ids=[8335],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},20018:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>h,routeModule:()=>p,serverHooks:()=>d,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>m});var n={};r.r(n),r.d(n,{GET:()=>c});var i=r(42706),s=r(28203),l=r(45994),a=r(39187),o=r(96925),u=r(79654);async function c(){let e=await (0,o.a6)();if(!e)return a.NextResponse.json({client:null});let t=await (0,u.JE)(e.clientId),r=t?(0,u.sc)(t):null;return a.NextResponse.json({client:r||{id:e.clientId,name:e.name||"",phone:e.phone||"",bonus:0}})}let p=new i.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/auth/client/me/route",pathname:"/api/auth/client/me",filename:"route",bundlePath:"app/api/auth/client/me/route"},resolvedPagePath:"/Users/mycomp/Documents/IT/Projects/wasabi/wasabi-sayt-2/app/api/auth/client/me/route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:f,workUnitAsyncStorage:m,serverHooks:d}=p;function h(){return(0,l.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:m})}},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},39676:(e,t,r)=>{"use strict";r.d(t,{i:()=>l});let n=process.env.POSTER_TOKEN||process.env.POSTER_ACCESS_TOKEN,i=process.env.POSTER_BASE_URL;function s(e,t){if(!t)throw Error(`Missing env ${e}`);return t}async function l(e,t={},r={}){let a=s("POSTER_TOKEN",n),o=s("POSTER_BASE_URL",i).replace(/\/$/,""),u=r.httpMethod??"GET",c=new URL(`${o}/${e}`);c.searchParams.set("token",a),c.searchParams.set("format","json");let p={cache:"no-store",method:u};if("GET"===u)for(let[e,r]of Object.entries(t))void 0!==r&&c.searchParams.set(e,String(r));else{let e=new URLSearchParams;for(let[r,n]of Object.entries(t))void 0!==n&&e.set(r,String(n));p.headers={"content-type":"application/x-www-form-urlencoded;charset=UTF-8"},p.body=e.toString()}let f=await fetch(c.toString(),p),m=await f.text().catch(()=>"");if(!f.ok)throw Error(`Poster error ${f.status}: ${m||f.statusText}`);let d=m?JSON.parse(m):{};if(d?.error){let e="object"==typeof d.error?JSON.stringify(d.error):String(d.error),t=d?.message?` ${d.message}`:"";throw Error(`Poster API error: ${e}${t}`)}return d}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},63464:(e,t,r)=>{"use strict";r.d(t,{P:()=>i});let n=new Map;async function i(e,t,r){let i=Date.now(),s=n.get(e);if(s&&s.expiresAt>i)return s.value;let l=await r();return n.set(e,{value:l,expiresAt:i+t}),l}},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79654:(e,t,r)=>{"use strict";r.d(t,{H0:()=>p,JE:()=>f,bu:()=>m,cz:()=>s,sc:()=>u});var n=r(39676),i=r(63464);function s(e){return e.replace(/\D/g,"")}function l(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;if("string"==typeof e){let t=Number(e.replace(/\s+/g,"").replace(",",".").replace(/[^0-9.-]/g,""));return Number.isFinite(t)?t:null}if("object"==typeof e)for(let t of Object.values(e)){let e=l(t);if(null!==e)return e}return null}function a(e){if(!e)return[];if(Array.isArray(e))return e;let t=e.response??e.clients??e.data??e.result??e;return Array.isArray(t)?t:Array.isArray(t?.data)?t.data:Array.isArray(t?.clients)?t.clients:Array.isArray(t?.items)?t.items:t&&"object"==typeof t&&(t.client_id||t.id)?[t]:[]}function o(e){return String(e.phone??e.phone_number??e.tel??"").trim()||""}function u(e){let t=function(e){let t=e.client_id??e.id??e.clientId??e.client_id_poster??e.customer_id??e.customerId;return(null!=t?String(t).trim():"")||null}(e);return t?{id:t,name:function(e){let t=String(e.client_name??e.name??e.full_name??e.fullname??"").trim();if(t)return t;let r=String(e.firstname??e.first_name??e.firstName??"").trim();return[r,String(e.lastname??e.last_name??e.lastName??"").trim(),String(e.patronymic??e.middle_name??e.middleName??"").trim()].filter(Boolean).join(" ")}(e),phone:function(e){let t=String(e||"").trim();if(!t)return"";if(t.startsWith("+"))return t;let r=s(t);return r?r.startsWith("998")?`+${r}`:9===r.length?`+998${r}`:10===r.length&&r.startsWith("0")?`+998${r.slice(1)}`:t:t}(o(e)),bonus:function(e){let t=l(e.bonus)??l(e.bonus_points)??l(e.bonus_sum)??l(e.bonus_total)??l(e.bonus_amount)??l(e.balance);return null!=t?t/100:0}(e)}:null}async function c(){let e=process.env.POSTER_CLIENT_GROUP_ID;if(e&&e.trim())return e.trim();try{let e=await (0,i.P)("poster:client_groups",3e5,()=>(0,n.i)("clients.getGroups")),t=Array.isArray(e?.response)?e.response:[];if(!t.length)return null;let r=t.find(e=>"1"!==String(e?.delete??"0"))??t[0],s=r?.client_groups_id;if(null==s)return null;return String(s).trim()||null}catch{return null}}async function p(e){let t=String(e||"").trim();if(!t)return null;let r=s(t),i=r?`+${r}`:"",l=async e=>a(await (0,n.i)("clients.getClients",{phone:e}));try{let e=[t,r,i].filter(Boolean),n=new Set,a=[];for(let t of e)if(!n.has(t)&&(n.add(t),(a=await l(t)).length))break;if(!a.length)return null;let u=r||s(t);return a.find(e=>{let t=s(o(e));return!!t&&!!u&&t===u})??a[0]??null}catch{return null}}async function f(e){let t=String(e||"").trim();if(!t)return null;try{let e=await (0,n.i)("clients.getClient",{client_id:t});return a(e)[0]??null}catch{try{let e=await (0,n.i)("clients.getClients",{client_id:t});return a(e)[0]??null}catch{return null}}}async function m({name:e,phone:t,email:r,birthday:i}){let l=String(e||"").trim(),o=String(t||"").trim();if(!l||!o)return null;let u=s(o),p=u?`+${u}`:"",f=function(e){if(!e)return;let t=e.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(t)return`${t[3]}.${t[2]}.${t[1]}`}(i),m=function(e){if(!e)return;let t=e.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(t)return`${t[3]}-${t[2]}-${t[1]}`}(i),d=l.split(/\s+/).filter(Boolean),h=d[0]||"",_=d.slice(1).join(" ")||"",g=await c()||void 0,y=r||void 0,w=async(e,t)=>{let r=await (0,n.i)(e,t,{httpMethod:"POST"}),i=a(r);if(i.length)return i[0];let s=r?.response??r;return s&&"object"==typeof s?s:null},S=[o,u,p].filter(Boolean),b=[i,f,m].filter(Boolean),E=[];for(let e of S){for(let t of(E.push({client_name:l,phone:e,client_phone:e,phone_number:e,client_groups_id_client:g,email:y}),b))E.push({client_name:l,phone:e,client_phone:e,phone_number:e,client_groups_id_client:g,email:y,birthday:t,birthdate:t,birth_date:t});E.push({name:l,phone:e,client_phone:e,phone_number:e,client_groups_id_client:g,email:y}),h&&E.push({first_name:h,last_name:_||void 0,client_name:l,phone:e,client_phone:e,phone_number:e,client_groups_id_client:g,email:y})}let x=null;for(let e of["clients.createClient","clients.create","clients.addClient","clients.createOrUpdate"])for(let t of E)try{let r=await w(e,t);if(r)return r}catch(r){let e=r instanceof Error?r.message:String(r),t=/Unknown API method|Unknown method/i.test(e);(!x||!t||/Unknown API method|Unknown method/i.test(x))&&(x=e)}if(x)throw Error(x);return null}},96487:()=>{},96925:(e,t,r)=>{"use strict";r.d(t,{S_:()=>c,a6:()=>p,rm:()=>f});var n=r(43008),i=r.n(n),s=r(44512);let l=process.env.CLIENT_COOKIE_NAME||"wasabi_client_session";function a(){let e=process.env.CLIENT_JWT_SECRET||process.env.ADMIN_JWT_SECRET;if(!e)throw Error("Missing CLIENT_JWT_SECRET");return e}async function o(e){(await (0,s.UL)()).set(l,e,{httpOnly:!0,sameSite:"lax",secure:!0,path:"/"})}async function u(){(await (0,s.UL)()).set(l,"",{httpOnly:!0,sameSite:"lax",secure:!0,path:"/",maxAge:0})}async function c(e){let t=function(e){let t=a();return i().sign(e,t,{expiresIn:"30d"})}({sub:e.clientId,phone:e.phone,name:e.name});await o(t)}async function p(){let e=await (0,s.UL)(),t=e.get(l)?.value;if(!t)return null;let r=function(e){try{let t=a();return i().verify(e,t)}catch{return null}}(t);return r?{clientId:r.sub,phone:r.phone,name:r.name}:null}async function f(){await u()}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[638,5452,4512,3008],()=>r(20018));module.exports=n})();