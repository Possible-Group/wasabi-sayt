(()=>{var e={};e.id=9789,e.ids=[9789],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},23952:(e,t,r)=>{"use strict";r.d(t,{z:()=>i});var n=r(96330);let i=global.prisma||new n.PrismaClient({log:["error"]})},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},39676:(e,t,r)=>{"use strict";r.d(t,{i:()=>s});let n=process.env.POSTER_TOKEN||process.env.POSTER_ACCESS_TOKEN,i=process.env.POSTER_BASE_URL;function o(e,t){if(!t)throw Error(`Missing env ${e}`);return t}async function s(e,t={},r={}){let a=o("POSTER_TOKEN",n),l=o("POSTER_BASE_URL",i).replace(/\/$/,""),u=r.httpMethod??"GET",c=new URL(`${l}/${e}`);c.searchParams.set("token",a),c.searchParams.set("format","json");let p={cache:"no-store",method:u};if("GET"===u)for(let[e,r]of Object.entries(t))void 0!==r&&c.searchParams.set(e,String(r));else{let e=new URLSearchParams;for(let[r,n]of Object.entries(t))void 0!==n&&e.set(r,String(n));p.headers={"content-type":"application/x-www-form-urlencoded;charset=UTF-8"},p.body=e.toString()}let d=await fetch(c.toString(),p),m=await d.text().catch(()=>"");if(!d.ok)throw Error(`Poster error ${d.status}: ${m||d.statusText}`);let f=m?JSON.parse(m):{};if(f?.error){let e="object"==typeof f.error?JSON.stringify(f.error):String(f.error),t=f?.message?` ${f.message}`:"";throw Error(`Poster API error: ${e}${t}`)}return f}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},48251:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>A,routeModule:()=>x,serverHooks:()=>j,workAsyncStorage:()=>O,workUnitAsyncStorage:()=>T});var n={};r.r(n),r.d(n,{POST:()=>R});var i=r(42706),o=r(28203),s=r(45994),a=r(39187),l=r(65658),u=r(23952),c=r(87967),p=r(96925),d=r(79654),m=r(39676),f=r(63464);let _=l.Ik({product_id:l.Yj(),name:l.Yj(),price:l.ai().nonnegative(),qty:l.ai().int().positive(),menu_category_id:l.KC([l.Yj(),l.ai()]).optional(),photo:l.Yj().optional()}),h=l.Ik({customerPhone:l.Yj().optional(),customerName:l.Yj().optional(),deliveryType:l.k5(["delivery","pickup"]),address:l.Yj().optional(),lat:l.ai().optional(),lng:l.ai().optional(),spotId:l.Yj().optional(),persons:l.ai().int().positive().optional(),promoCode:l.Yj().optional(),comment:l.Yj().optional(),paymentMethod:l.k5(["cash","card"]),bonusAmount:l.ai().nonnegative().optional(),items:l.YO(_).min(1),utm:l.g1(l.Yj()).optional()});function y(e,t){let r=Number(e);return Number.isFinite(r)?r:t}function g(e){return e.trim().toUpperCase()}async function w(e){let t=g(e);if(!t)return null;try{let e=await (0,f.P)("poster:promo_codes",6e4,()=>(0,m.i)("clients.getPromotions"));for(let r of Array.isArray(e?.response)?e.response:[]){if("1"!==String(r?.auto_apply??""))continue;let e=String(r?.name??""),n=function(e){let t=e.split("$");return t.length<2?"":g(t[1].trim())}(e);if(n&&n===t){let e=Number(r?.params?.discount_value??0)||0,t=Number(r?.params?.result_type??0)||0,n=r?.promotion_id,i=null!=n&&String(n).trim()?Number(n):null;return{promotionId:Number.isFinite(i)?i:null,discountValue:e,resultType:t}}}return null}catch{return null}}function b(e,t){return!t||t.discountValue<=0?e:3===t.resultType?e*(1-t.discountValue/100):1===t.resultType?Math.max(0,e-t.discountValue):e}function S(e){return e.replace(/\D/g,"")}function v(e){return`${e.toLocaleString("ru-RU")} ÑÑƒÐ¼`}function N(e){return e.replace(/[<>&]/g,e=>"<"===e?"&lt;":">"===e?"&gt;":"&amp;")}async function E(e){let t=process.env.TELEGRAM_BOT_TOKEN,r=process.env.TELEGRAM_GROUP_CHAT_ID;t&&r&&await fetch(`https://api.telegram.org/bot${t}/sendMessage`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({chat_id:r,text:e,parse_mode:"HTML",disable_web_page_preview:!0})}).catch(()=>null)}async function R(e){var t;let r=e.headers.get("x-forwarded-for")?.split(",")[0]?.trim()||"local",n=Number(process.env.ORDER_RATE_LIMIT_PER_MIN||10);if(!(0,c.i)(`order:${r}`,n,6e4).ok)return a.NextResponse.json({error:"Too many requests"},{status:429});let i=await e.json().catch(()=>null),o=h.safeParse(i);if(!o.success)return a.NextResponse.json({error:"INVALID_BODY"},{status:400});let s=o.data,l=await (0,p.a6)();if(!l)return a.NextResponse.json({error:"UNAUTHORIZED"},{status:401});let m=await u.z.botSetting.findMany({where:{key:{in:["work_start","work_end","package_fee","delivery_fee"]}}}),f={};m.forEach(e=>f[e.key]=e.value);let _=f.work_start||"10:00",R=f.work_end||"23:00";if(!function(e,t,r){let[n,i]=t.split(":").map(Number),[o,s]=r.split(":").map(Number),a=new Date(e);a.setHours(n,i,0,0);let l=new Date(e);if(l.setHours(o,s,0,0),l<=a){let t=new Date(l);t.setDate(t.getDate()+1);let r=new Date(e);return e<a&&r.setDate(r.getDate()+1),r>=a&&r<=t}return e>=a&&e<=l}(new Date,_,R))return a.NextResponse.json({error:"CLOSED",workStart:_,workEnd:R},{status:400});let x=y(f.package_fee,0),O=y(f.delivery_fee,0),T=s.deliveryType,j=String(s.address??"").trim(),A=s.lat,I=s.lng,P=String(s.spotId??"").trim();if("delivery"===T){if(!j)return a.NextResponse.json({error:"ADDRESS_REQUIRED"},{status:400});if("number"!=typeof A||"number"!=typeof I)return a.NextResponse.json({error:"LOCATION_REQUIRED"},{status:400})}else if(!P)return a.NextResponse.json({error:"SPOT_REQUIRED"},{status:400});let $=s.promoCode?g(s.promoCode):"",k=$?await w($):null;if($&&!k)return a.NextResponse.json({error:"INVALID_PROMO"},{status:400});let D=await (0,d.JE)(l.clientId),M=D?(0,d.sc)(D):null,C=Number(M?.bonus??0)||0,U=String(s.customerPhone??"").trim()||String(l.phone??"").trim()||String(M?.phone??"").trim(),L=String(s.customerName??"").trim()||String(l.name??"").trim()||String(M?.name??"").trim();if(!U)return a.NextResponse.json({error:"PHONE_REQUIRED"},{status:400});let q=S(l.clientId);if(!q)return a.NextResponse.json({error:"CLIENT_ID_INVALID"},{status:400});let J=s.items.reduce((e,t)=>e+t.price*t.qty,0),Y=(k?s.items.reduce((e,t)=>{let r=b(t.price,{...k,discountValue:1===k.resultType?100*k.discountValue:k.discountValue});return e+Math.max(0,t.price-r)*t.qty},0):0)/100,B=Math.max(0,J/100-Y+(x+("delivery"===T?O:0))),F=Number(s.bonusAmount??0)||0,V=Math.min(F,C,B);if(F>C)return a.NextResponse.json({error:"BONUS_EXCEEDED",bonusAvailable:C},{status:400});let H=Math.max(0,B-V),G=Math.round(100*H),K="delivery"===T?3:2,W=S(P),z=s.items.map(e=>{let t=S(e.product_id),r=t?Number(t):Number(e.product_id),n=e.price/100,i=k?b(n,k):n;return{product_id:Number.isFinite(r)?r:0,product_name:e.name,count:e.qty,price:n,discounted_price:i,promotion_id:k?.promotionId??null,discount_value:k?.discountValue??0,result_type:k?.resultType??0,menu_category_id:e.menu_category_id??void 0,photo_origin:e.photo??void 0}}),Q={service_mode:K,spot_id:W?Number(W):0,payment_method:s.paymentMethod,bonus:V,products:z,total:H,chat_id:0,phone:U,location:"delivery"===T?{latitude:A,longitude:I}:{latitude:0,longitude:0},status:"bot",client_id:Number(q),pers_num:s.persons??1,comment:s.comment??"",address:"delivery"===T?j:"",promocode:$||"",promocode_id:k?.promotionId??0};console.log("Order payload:",JSON.stringify(Q,null,2));let X=await fetch("https://wasabi-admin.onrender.com/api/order",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(Q)}),Z=await X.text().catch(()=>"");if(!X.ok)return a.NextResponse.json({error:"ORDER_API_ERROR",detail:Z||X.statusText},{status:502});let ee=null;if(Z)try{ee=JSON.parse(Z)}catch{ee=null}let et=await u.z.order.create({data:{externalId:ee?.order_id!==void 0&&ee?.order_id!==null?String(ee.order_id):null,customerPhone:U,customerName:L||null,deliveryType:T,address:"delivery"===T?j:null,lat:"delivery"===T?A??null:null,lng:"delivery"===T?I??null:null,persons:s.persons??1,itemsJson:JSON.stringify(s.items),subtotal:J,packageFee:Math.round(100*x),deliveryFee:Math.round(100*O),discount:Math.round((Y+V)*100),total:G,status:"new"}}),er=z.length?z.map(e=>`â€¢ ${N(e.product_name)} â€” ${e.count} ÑˆÑ‚.`).join("\n"):"â€”",en="delivery"===T?"Ð”Ð¾ÑÑ‚Ð°Ð²ÐºÐ°":"ÐÐ°Ð²Ñ‹Ð½Ð¾Ñ",ei=ee?.order_id?`Ð—Ð°ÐºÐ°Ð· #${ee.order_id}`:`Ð—Ð°ÐºÐ°Ð· #${et.id}`,eo="delivery"===T?`ÐÐ´Ñ€ÐµÑ: ${N(j||"â€”")}`:W?`Ð¤Ð¸Ð»Ð¸Ð°Ð»: ${W}`:"Ð¤Ð¸Ð»Ð¸Ð°Ð»: â€”",es=$?`ÐŸÑ€Ð¾Ð¼Ð¾ÐºÐ¾Ð´: ${$}`:"ÐŸÑ€Ð¾Ð¼Ð¾ÐºÐ¾Ð´: â€”",ea=V>0?`Ð‘Ð¾Ð½ÑƒÑÑ‹: ${v(V)}`:"Ð‘Ð¾Ð½ÑƒÑÑ‹: â€”",el=s.comment?`ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹: ${N(s.comment)}`:"ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹: â€”",eu=[`ðŸ£ ${ei}`,`Ð¢Ð¸Ð¿: ${en}`,`Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½: ${N(U)}`,eo,`ÐžÐ¿Ð»Ð°Ñ‚Ð°: ${"card"===(t=s.paymentMethod)?"ÐšÐ°Ñ€Ñ‚Ð°":"cash"===t?"ÐÐ°Ð»Ð¸Ñ‡Ð½Ñ‹Ð¼Ð¸":t||"â€”"}`,`Ð¡ÑƒÐ¼Ð¼Ð°: ${v(H)}`,ea,es,"Ð¢Ð¾Ð²Ð°Ñ€Ñ‹:",er,el].join("\n");return await E(eu),a.NextResponse.json({ok:!0,orderId:et.id})}let x=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/orders/route",pathname:"/api/orders",filename:"route",bundlePath:"app/api/orders/route"},resolvedPagePath:"/Users/mycomp/Documents/IT/Projects/wasabi/wasabi-sayt-2/app/api/orders/route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:O,workUnitAsyncStorage:T,serverHooks:j}=x;function A(){return(0,s.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:T})}},55511:e=>{"use strict";e.exports=require("crypto")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},63464:(e,t,r)=>{"use strict";r.d(t,{P:()=>i});let n=new Map;async function i(e,t,r){let i=Date.now(),o=n.get(e);if(o&&o.expiresAt>i)return o.value;let s=await r();return n.set(e,{value:s,expiresAt:i+t}),s}},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79654:(e,t,r)=>{"use strict";r.d(t,{H0:()=>p,JE:()=>d,bu:()=>m,cz:()=>o,sc:()=>u});var n=r(39676),i=r(63464);function o(e){return e.replace(/\D/g,"")}function s(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;if("string"==typeof e){let t=Number(e.replace(/\s+/g,"").replace(",",".").replace(/[^0-9.-]/g,""));return Number.isFinite(t)?t:null}if("object"==typeof e)for(let t of Object.values(e)){let e=s(t);if(null!==e)return e}return null}function a(e){if(!e)return[];if(Array.isArray(e))return e;let t=e.response??e.clients??e.data??e.result??e;return Array.isArray(t)?t:Array.isArray(t?.data)?t.data:Array.isArray(t?.clients)?t.clients:Array.isArray(t?.items)?t.items:t&&"object"==typeof t&&(t.client_id||t.id)?[t]:[]}function l(e){return String(e.phone??e.phone_number??e.tel??"").trim()||""}function u(e){let t=function(e){let t=e.client_id??e.id??e.clientId??e.client_id_poster??e.customer_id??e.customerId;return(null!=t?String(t).trim():"")||null}(e);return t?{id:t,name:function(e){let t=String(e.client_name??e.name??e.full_name??e.fullname??"").trim();if(t)return t;let r=String(e.firstname??e.first_name??e.firstName??"").trim();return[r,String(e.lastname??e.last_name??e.lastName??"").trim(),String(e.patronymic??e.middle_name??e.middleName??"").trim()].filter(Boolean).join(" ")}(e),phone:function(e){let t=String(e||"").trim();if(!t)return"";if(t.startsWith("+"))return t;let r=o(t);return r?r.startsWith("998")?`+${r}`:9===r.length?`+998${r}`:10===r.length&&r.startsWith("0")?`+998${r.slice(1)}`:t:t}(l(e)),bonus:function(e){let t=s(e.bonus)??s(e.bonus_points)??s(e.bonus_sum)??s(e.bonus_total)??s(e.bonus_amount)??s(e.balance);return null!=t?t/100:0}(e)}:null}async function c(){let e=process.env.POSTER_CLIENT_GROUP_ID;if(e&&e.trim())return e.trim();try{let e=await (0,i.P)("poster:client_groups",3e5,()=>(0,n.i)("clients.getGroups")),t=Array.isArray(e?.response)?e.response:[];if(!t.length)return null;let r=t.find(e=>"1"!==String(e?.delete??"0"))??t[0],o=r?.client_groups_id;if(null==o)return null;return String(o).trim()||null}catch{return null}}async function p(e){let t=String(e||"").trim();if(!t)return null;let r=o(t),i=r?`+${r}`:"",s=async e=>a(await (0,n.i)("clients.getClients",{phone:e}));try{let e=[t,r,i].filter(Boolean),n=new Set,a=[];for(let t of e)if(!n.has(t)&&(n.add(t),(a=await s(t)).length))break;if(!a.length)return null;let u=r||o(t);return a.find(e=>{let t=o(l(e));return!!t&&!!u&&t===u})??a[0]??null}catch{return null}}async function d(e){let t=String(e||"").trim();if(!t)return null;try{let e=await (0,n.i)("clients.getClient",{client_id:t});return a(e)[0]??null}catch{try{let e=await (0,n.i)("clients.getClients",{client_id:t});return a(e)[0]??null}catch{return null}}}async function m({name:e,phone:t,email:r,birthday:i}){let s=String(e||"").trim(),l=String(t||"").trim();if(!s||!l)return null;let u=o(l),p=u?`+${u}`:"",d=function(e){if(!e)return;let t=e.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(t)return`${t[3]}.${t[2]}.${t[1]}`}(i),m=function(e){if(!e)return;let t=e.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(t)return`${t[3]}-${t[2]}-${t[1]}`}(i),f=s.split(/\s+/).filter(Boolean),_=f[0]||"",h=f.slice(1).join(" ")||"",y=await c()||void 0,g=r||void 0,w=async(e,t)=>{let r=await (0,n.i)(e,t,{httpMethod:"POST"}),i=a(r);if(i.length)return i[0];let o=r?.response??r;return o&&"object"==typeof o?o:null},b=[l,u,p].filter(Boolean),S=[i,d,m].filter(Boolean),v=[];for(let e of b){for(let t of(v.push({client_name:s,phone:e,client_phone:e,phone_number:e,client_groups_id_client:y,email:g}),S))v.push({client_name:s,phone:e,client_phone:e,phone_number:e,client_groups_id_client:y,email:g,birthday:t,birthdate:t,birth_date:t});v.push({name:s,phone:e,client_phone:e,phone_number:e,client_groups_id_client:y,email:g}),_&&v.push({first_name:_,last_name:h||void 0,client_name:s,phone:e,client_phone:e,phone_number:e,client_groups_id_client:y,email:g})}let N=null;for(let e of["clients.createClient","clients.create","clients.addClient","clients.createOrUpdate"])for(let t of v)try{let r=await w(e,t);if(r)return r}catch(r){let e=r instanceof Error?r.message:String(r),t=/Unknown API method|Unknown method/i.test(e);(!N||!t||/Unknown API method|Unknown method/i.test(N))&&(N=e)}if(N)throw Error(N);return null}},87967:(e,t,r)=>{"use strict";r.d(t,{i:()=>i});let n=new Map;function i(e,t,r){let i=Date.now(),o=n.get(e);return!o||o.resetAt<i?(n.set(e,{count:1,resetAt:i+1e3*t}),{ok:!0,remaining:r-1}):o.count>=r?{ok:!1,remaining:0,retryAfterMs:o.resetAt-i}:(o.count+=1,n.set(e,o),{ok:!0,remaining:r-o.count})}},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{},96925:(e,t,r)=>{"use strict";r.d(t,{S_:()=>c,a6:()=>p,rm:()=>d});var n=r(43008),i=r.n(n),o=r(44512);let s=process.env.CLIENT_COOKIE_NAME||"wasabi_client_session";function a(){let e=process.env.CLIENT_JWT_SECRET||process.env.ADMIN_JWT_SECRET;if(!e)throw Error("Missing CLIENT_JWT_SECRET");return e}async function l(e){(await (0,o.UL)()).set(s,e,{httpOnly:!0,sameSite:"lax",secure:!0,path:"/"})}async function u(){(await (0,o.UL)()).set(s,"",{httpOnly:!0,sameSite:"lax",secure:!0,path:"/",maxAge:0})}async function c(e){let t=function(e){let t=a();return i().sign(e,t,{expiresIn:"30d"})}({sub:e.clientId,phone:e.phone,name:e.name});await l(t)}async function p(){let e=await (0,o.UL)(),t=e.get(s)?.value;if(!t)return null;let r=function(e){try{let t=a();return i().verify(e,t)}catch{return null}}(t);return r?{clientId:r.sub,phone:r.phone,name:r.name}:null}async function d(){await u()}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[638,5452,4512,3008,5658],()=>r(48251));module.exports=n})();