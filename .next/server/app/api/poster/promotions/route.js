(()=>{var r={};r.id=2658,r.ids=[2658],r.modules={2381:(r,e,t)=>{"use strict";function i(r){return null==r?null:String(r).trim()||null}function o(r,e){if(!r||"object"!=typeof r)return r;let t=i(r.category_id??r.categoryId??r.product_category_id??r.productCategoryId??r.category?.category_id??r.category?.id??e);return t?{...r,category_id:t}:r}function n(r){let e=(function(r){let e=r?.response;if(Array.isArray(e))return e;if(Array.isArray(e?.products))return e.products;if(Array.isArray(e?.items))return e.items;let t=(r,e)=>{let t=i(r?.category_id??r?.categoryId??r?.id??r?.category?.category_id??e);return Array.isArray(r?.products)?r.products.map(r=>o(r,t)):Array.isArray(r?.items)?r.items.map(r=>o(r,t)):[]};if(Array.isArray(e?.categories)){let r=e.categories.flatMap(r=>t(r));if(r.length)return r}if(e?.categories&&"object"==typeof e.categories){let r=Object.entries(e.categories).flatMap(([r,e])=>t(e,r));if(r.length)return r}if(e?.products&&"object"==typeof e.products){let r=Object.entries(e.products).flatMap(([r,e])=>Array.isArray(e)?e.map(e=>o(e,r)):Array.isArray(e?.products)?e.products.map(e=>o(e,r)):Array.isArray(e?.items)?e.items.map(e=>o(e,r)):[o(e,r)]);if(r.length)return r}if(e&&"object"==typeof e){let r=Object.values(e).flatMap(r=>Array.isArray(r)?r:[]);if(r.length)return r}return[]})(r).filter(r=>r&&(r.product_id||r.id||r.product_name||r.name)),t=process.env.POSTER_BASE_URL,n="";if(t)try{n=new URL(t).origin}catch{n=""}let a=r=>{let e="string"==typeof r?r.trim():"";return e?e.startsWith("/")&&n?`${n}${e}`:e:null};return e.map(r=>{let e=[r.photo_origin,r.photoOrigin,r.photo_big_origin,r.photoBigOrigin,r.photo_big,r.photoBig,r.photo_large,r.photoLarge,r.photo,r.image].find(r=>"string"==typeof r&&r.trim())||null,t=r.photo??null,i=e||t||null;return{product_id:String(r.product_id??r.id??""),product_name:function(r){let e="string"==typeof r?r.trim():"";if(!e)return"";let t=e.indexOf("$");return t>=0?e.slice(0,t).trim():e}(r.product_name??r.name??""),price:function(r){for(let e of[r?.price?.[1],r?.price?.["1"],r?.price,r?.product_price,r?.price_sum,r?.price_1,r?.price1,r?.price2,r?.price3,r?.price4,r?.price5,r?.price6,r?.price7,r?.price8,r?.price9,r?.prices]){let r=function r(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;if("string"==typeof e){let r=Number(e.replace(/\s+/g,"").replace(",",".").replace(/[^0-9.-]/g,""));return Number.isFinite(r)?r:null}if(Array.isArray(e)){for(let t of e){let e=r(t);if(e&&e>0)return e}return null}if("object"==typeof e){for(let t of[e.price,e.value,e.sum,e.amount]){let e=r(t);if(e&&e>0)return e}for(let t of Object.values(e)){let e=r(t);if(e&&e>0)return e}}return null}(e);if(r&&r>0)return r}return 0}(r),photo:a(i),photo_origin:a(e),photo_raw:t,ingredients:r.ingredients??null,description:r.description??null,category_name:r.category_name??r.menu_category_name??r.category?.category_name??r.category?.name??null,category_id:r.category_id?String(r.category_id):r.menu_category_id?String(r.menu_category_id):r.menuCategoryId?String(r.menuCategoryId):r.categoryId?String(r.categoryId):r.category?.category_id?String(r.category.category_id):r.category?.id?String(r.category.id):r.product_category_id?String(r.product_category_id):r.productCategoryId?String(r.productCategoryId):null}})}t.d(e,{E:()=>n})},3295:r=>{"use strict";r.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:r=>{"use strict";r.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:r=>{"use strict";r.exports=require("next/dist/server/app-render/work-async-storage.external.js")},39676:(r,e,t)=>{"use strict";t.d(e,{i:()=>a});let i=process.env.POSTER_TOKEN||process.env.POSTER_ACCESS_TOKEN,o=process.env.POSTER_BASE_URL;function n(r,e){if(!e)throw Error(`Missing env ${r}`);return e}async function a(r,e={},t={}){let s=n("POSTER_TOKEN",i),u=n("POSTER_BASE_URL",o).replace(/\/$/,""),c=t.httpMethod??"GET",p=new URL(`${u}/${r}`);p.searchParams.set("token",s),p.searchParams.set("format","json");let l={cache:"no-store",method:c};if("GET"===c)for(let[r,t]of Object.entries(e))void 0!==t&&p.searchParams.set(r,String(t));else{let r=new URLSearchParams;for(let[t,i]of Object.entries(e))void 0!==i&&r.set(t,String(i));l.headers={"content-type":"application/x-www-form-urlencoded;charset=UTF-8"},l.body=r.toString()}let d=await fetch(p.toString(),l),g=await d.text().catch(()=>"");if(!d.ok)throw Error(`Poster error ${d.status}: ${g||d.statusText}`);let f=g?JSON.parse(g):{};if(f?.error){let r="object"==typeof f.error?JSON.stringify(f.error):String(f.error),e=f?.message?` ${f.message}`:"";throw Error(`Poster API error: ${r}${e}`)}return f}},41962:(r,e,t)=>{"use strict";t.r(e),t.d(e,{patchFetch:()=>b,routeModule:()=>_,serverHooks:()=>S,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>A});var i={};t.r(i),t.d(i,{GET:()=>y,dynamic:()=>l});var o=t(42706),n=t(28203),a=t(45994),s=t(39187),u=t(39676),c=t(63464),p=t(2381);let l="force-dynamic";function d(r){if(!r||"0000-00-00 00:00:00"===r)return null;let e=r.replace(" ","T"),t=new Date(`${e}Z`);return Number.isNaN(t.getTime())?null:t}function g(r){if(!r)return null;let e=r.match(/^(\d{1,2}):(\d{2})$/);if(!e)return null;let t=Number(e[1]),i=Number(e[2]);return Number.isFinite(t)&&Number.isFinite(i)?60*Math.min(23,Math.max(0,t))+Math.min(59,Math.max(0,i)):null}function f(r,e){let t=function(r){if(r){if(Array.isArray(r))return r;if("object"==typeof r){let e=Object.values(r);return e.length?e:void 0}}}(r);if(!t||0===t.length)return;if(!e)return t;let i=t.filter(r=>{if(!r||"object"!=typeof r)return!1;let t=String(r.product_id??r.productId??"").trim();return!!t&&t===e});return i.length?i:t}async function m(){let r=await (0,u.i)("menu.getProducts"),e=(0,p.E)(r);if(0===e.length){let r=await (0,u.i)("menu.getCategories"),t=(Array.isArray(r?.response)&&r.response||Array.isArray(r?.categories)&&r.categories||[]).map(r=>String(r?.category_id??r?.id??"").trim()).filter(Boolean);e=(await Promise.all(t.map(r=>(0,u.i)("menu.getProducts",{category_id:r}).catch(()=>null)))).flatMap((r,e)=>{if(!r)return[];let i=(0,p.E)(r);if(!i.length)return[];let o=t[e];return i.map(r=>r.category_id?r:{...r,category_id:o})})}return e}async function y(){let r=new Date,e=function(){let r=new Intl.DateTimeFormat("en-GB",{timeZone:"Asia/Tashkent",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(new Date);return 60*Number(r.find(r=>"hour"===r.type)?.value??0)+Number(r.find(r=>"minute"===r.type)?.value??0)}(),[t,i]=await Promise.all([(0,c.P)("poster:promotions",6e4,()=>(0,u.i)("clients.getPromotions")),(0,c.P)("poster:products:all",6e4,()=>m())]),o=Array.isArray(t?.response)?t.response:t?.response?[t.response]:[],n={};i.forEach(r=>{let e=String(r.product_id??r.id??"").trim(),t=String(r.category_id??"").trim();e&&t&&(n[t]||(n[t]=[]),n[t].push(e))});let a={};return o.forEach(t=>{if(!function(r,e,t){if("1"!==String(r?.auto_apply??""))return!1;let i=d(r?.date_start),o=d(r?.date_end);return(!i||!(e<i))&&(!o||!(e>o))&&!!function(r,e){if(!r||0===r.length)return!0;for(let t of r){let r=g(t?.start),i=g(t?.end);if(null!==r&&null!==i){if(r<=i){if(e>=r&&e<=i)return!0}else if(e>=r||e<=i)return!0}}return!1}(r?.params?.periods,t)}(t,r,e))return;let i=Number(t?.params?.discount_value??0)||0,o=Number(t?.params?.result_type??0)||0,s=t?.promotion_id,u=null!=s&&String(s).trim()?Number(s):null,c=t?.params?.discount_prices;(Array.isArray(t?.params?.conditions)?t.params.conditions:[]).forEach(r=>{let e=Number(r?.type??0),t=String(r?.id??"").trim();if(!t)return;let s=f(c,t);(!(i<=0)||s&&0!==s.length)&&(2===e?a[t]={discount_value:i,result_type:o,promotion_id:u,discount_prices:s}:1===e&&(n[t]||[]).forEach(r=>{let e=f(c,r);(!(i<=0)||e&&0!==e.length)&&(a[r]={discount_value:i,result_type:o,promotion_id:u,discount_prices:e})}))}),(Array.isArray(t?.params?.bonus_products)?t.params.bonus_products:[]).forEach(r=>{let e=String(r?.id??"").trim();e&&(a[e]={discount_value:100,result_type:1,promotion_id:u,is_bonus:!0})})}),s.NextResponse.json({discounts:a,updatedAt:new Date().toISOString()})}let _=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/poster/promotions/route",pathname:"/api/poster/promotions",filename:"route",bundlePath:"app/api/poster/promotions/route"},resolvedPagePath:"/Users/mycomp/Documents/IT/Projects/wasabi/wasabi-sayt-2/app/api/poster/promotions/route.ts",nextConfigOutput:"",userland:i}),{workAsyncStorage:h,workUnitAsyncStorage:A,serverHooks:S}=_;function b(){return(0,a.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:A})}},44870:r=>{"use strict";r.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:r=>{"use strict";r.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},63464:(r,e,t)=>{"use strict";t.d(e,{P:()=>o});let i=new Map;async function o(r,e,t){let o=Date.now(),n=i.get(r);if(n&&n.expiresAt>o)return n.value;let a=await t();return i.set(r,{value:a,expiresAt:o+e}),a}},78335:()=>{},96487:()=>{}};var e=require("../../../../webpack-runtime.js");e.C(r);var t=r=>e(e.s=r),i=e.X(0,[638,5452],()=>t(41962));module.exports=i})();